name: Deploy to VPS - BarberHub

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      remote_path:
        description: "Pasta no servidor (ex: /docker/barberhub)"
        required: false
        default: "/docker/barberhub"
      compose_file:
        description: "Arquivo compose (docker-compose.yml ou docker-compose.prod.yml)"
        required: false
        default: "docker-compose.yml"
      prune:
        description: "Limpar imagens antigas (true/false)"
        required: false
        default: "true"

concurrency:
  group: deploy-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          command_timeout: 30m
          envs: REMOTE_PATH,COMPOSE_FILE,PRUNE
          script: |
            set -euo pipefail

            # Valores com fallback dos inputs
            REMOTE_PATH="${REMOTE_PATH:-${{ inputs.remote_path }}}"
            COMPOSE_FILE="${COMPOSE_FILE:-${{ inputs.compose_file }}}"
            PRUNE="${PRUNE:-${{ inputs.prune }}}"

            echo "=== DEPLOY BARBERHUB ==="
            echo "Pasta remota: $REMOTE_PATH"
            echo "Compose file: $COMPOSE_FILE"
            echo "Prune: $PRUNE"

            # Verifica e entra no diretório
            if [ ! -d "$REMOTE_PATH" ]; then
              echo "ERRO: Diretório não existe: $REMOTE_PATH" >&2
              exit 1
            fi
            cd "$REMOTE_PATH"

            echo "Arquivos no diretório:"
            ls -la

            # Git sync
            if [ -d .git ]; then
              echo "Atualizando código Git..."
              git fetch origin --prune
              git checkout main
              git reset --hard origin/main
              git clean -fd
              echo "Commit atual: $(git rev-parse --short HEAD)"
            else
              echo "Aviso: .git não encontrado — código não será atualizado via git"
            fi

            # Verifica o compose file
            if [ ! -f "$COMPOSE_FILE" ]; then
              echo "ERRO: $COMPOSE_FILE não encontrado!" >&2
              echo "Arquivos disponíveis:"
              ls -la docker-compose*.yml
              exit 1
            fi

            echo "Configuração do compose válida"
            docker compose -f "$COMPOSE_FILE" config > /dev/null

            echo "Baixando imagens..."
            docker compose -f "$COMPOSE_FILE" pull || true

            echo "Subindo containers com build..."
            docker compose -f "$COMPOSE_FILE" up -d --build --remove-orphans

            echo "STATUS DOS CONTAINERS:"
            docker compose -f "$COMPOSE_FILE" ps

            if [ "$PRUNE" = "true" ]; then
              echo "Limpando imagens antigas..."
              docker image prune -f
            fi

            echo "=== DEPLOY CONCLUÍDO COM SUCESSO! ==="
            echo "BarberHub atualizado em https://seu-dominio.com"